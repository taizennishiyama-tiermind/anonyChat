# 要件定義書：匿名リアルタイムチャット（anonyChat）

**作成日**: 2025-12-02
**バージョン**: 1.0
**プロジェクト**: anonyChat - 企業研修向け匿名チャットシステム

---

## 目次

1. [システム概要](#1-システム概要)
2. [目的・背景](#2-目的背景)
3. [機能要件](#3-機能要件)
4. [非機能要件](#4-非機能要件)
5. [ユーザー体系](#5-ユーザー体系)
6. [データモデル](#6-データモデル)
7. [画面設計](#7-画面設計)
8. [API設計](#8-api設計)
9. [技術仕様](#9-技術仕様)
10. [セキュリティ要件](#10-セキュリティ要件)
11. [運用要件](#11-運用要件)

---

## 1. システム概要

### 1.1 アプリケーション名
**匿名リアルタイムチャット（anonyChat）**

### 1.2 システムの種類
リアルタイムメッセージング・リアクション収集システム（SPA）

### 1.3 概要説明
企業研修や講演会において、参加者が匿名で質問やリアクションをリアルタイムに共有できるWebアプリケーション。URLを共有するだけで、認証なしに誰でも参加可能。ホストモード機能により、講演者や事務局担当者は名前付きで投稿できる。

### 1.4 主要な特徴
- 🔗 **リンク共有による参加**: URLを共有するだけで即座に参加可能
- 🎭 **完全匿名機能**: ユーザー識別子（例: 「匿名の参加者#ABC1」）で参加
- 🗣️ **ホストモード**: 講演者・事務局用の名前付き投稿機能
- ⚡ **リアルタイム同期**: Supabaseによる自動更新（WebSocket）
- 📱 **モバイル最適化**: iOS・Android対応、レスポンシブデザイン
- 📊 **ダッシュボード機能**: メッセージ数・リアクション数の可視化

### 1.5 利用シーン
- 企業の新人研修
- 社内講演会・勉強会
- ウェビナー・オンラインセミナー
- ワークショップ
- オフサイトミーティング

---

## 2. 目的・背景

### 2.1 開発目的
企業研修において、参加者が気軽に質問や意見を表明できる環境を提供する。匿名性により、心理的安全性を確保し、発言のハードルを下げる。

### 2.2 解決する課題
- **発言への躊躇**: 大人数の研修で質問しにくい
- **リアルタイムフィードバックの不足**: 講演者が参加者の反応を把握できない
- **認証の煩雑さ**: アカウント登録なしで即座に利用したい
- **モバイル対応**: スマートフォンからも快適に参加したい

### 2.3 ビジネス価値
- 参加者のエンゲージメント向上
- 質問・意見の可視化による研修効果の向上
- 導入障壁の低さ（URL共有のみ）
- コスト効率（認証基盤不要）

---

## 3. 機能要件

### 3.1 ルーム管理機能

#### 3.1.1 ルーム作成
- **入力**: ルーム名（文字列）
- **処理**: 入力されたルーム名をURLエンコードして新規ルームを作成
- **出力**: `/room/{ルーム名}` へ遷移
- **制約**:
  - ルーム名は必須
  - 特殊文字は自動エンコード

#### 3.1.2 ルーム参加
- **入力**: ルームURL
- **処理**: 既存ルームに参加
- **出力**: チャット画面を表示
- **制約**: 事前作成されたルームが存在する必要あり

#### 3.1.3 最近のルーム
- **機能**: 直近に参加したルームを最大5件表示
- **保存先**: LocalStorage (`recentRooms`)
- **表示**: ホーム画面にリスト形式で表示
- **操作**: クリックで再参加

---

### 3.2 メッセージ機能

#### 3.2.1 メッセージ送信
- **入力**: テキスト（複数行対応）
- **処理**:
  - 匿名ユーザーIDまたはホスト名を付与
  - Supabase `messages` テーブルに挿入
  - リアルタイムで全参加者に配信
- **出力**: メッセージが画面に表示
- **制約**:
  - 空メッセージは送信不可
  - 最大文字数制限なし（UI上は自然な制限）
  - Enter キーで送信（Shift+Enter で改行）
  - IME入力中は送信しない

#### 3.2.2 メッセージ表示
- **送信者**: 右寄せ、青色背景
- **受信者**: 左寄せ、白/グレー背景
- **表示内容**:
  - ユーザー名（匿名ID または ホスト名）
  - タイムスタンプ（HH:MM形式）
  - メッセージ本文
  - ホストバッジ（ホストの場合）
- **自動スクロール**: 新規メッセージ受信時に最下部へスクロール

#### 3.2.3 URL自動リンク化
- **処理**: メッセージ内のURL（http://, https://）を自動検出
- **出力**: クリック可能なリンクとして表示
- **制約**:
  - `target="_blank"`: 新規タブで開く
  - `rel="noopener noreferrer"`: セキュリティ対策

#### 3.2.4 システムメッセージ
- **種類**:
  - デモモード通知
  - エラー通知
- **表示**: 中央寄せ、グレー色
- **user_id**: "システムメッセージ"

---

### 3.3 @メンション機能

#### 3.3.1 メンション入力
- **トリガー**: `@` 文字の入力
- **処理**:
  - 現在のルーム参加者リストを取得
  - 候補者をポップアップ表示
  - 入力文字でフィルタリング
- **表示**: 候補リスト（最大10件）
- **選択**: クリックまたはEnterキーで挿入

#### 3.3.2 メンション候補
- **表示内容**:
  - ユーザーID
  - ホストバッジ（該当する場合）
- **ソート**: ホストを上位に表示
- **フィルタ**: 部分一致検索

#### 3.3.3 メンションハイライト
- **処理**: メッセージ内の `@ユーザーID` を検出
- **表示**: 青色背景でハイライト表示
- **データ**: `mentions` 配列に保存（JSONB型）

---

### 3.4 リアクション機能

#### 3.4.1 ルームレベルのリアクション
- **種類**: 4種類
  - 👍 **いいね** (like) - 黄色
  - 💡 **ひらめき** (idea) - 青色
  - 🤔 **疑問** (question) - 緑色
  - 🍊 **みかん！** (confused) - 紫色
- **配置**: フッターのボタン群
- **処理**:
  - クリックで `reactions` テーブルに挿入
  - リアルタイムで全参加者に配信
  - カウント数を更新
- **アニメーション**: 絵文字が上昇するアニメーション（1秒間）

#### 3.4.2 メッセージレベルのリアクション
- **配置**: 各メッセージのリアクションピッカー
- **トリガー**:
  - デスクトップ: メッセージホバー時に表示
  - モバイル: 常時表示
- **処理**:
  - クリックで `message_reactions` テーブルに挿入
  - 該当メッセージにリアクションカウントを表示
- **表示**: リアクションタイプ別の集計（例: 👍 3, 💡 1）

#### 3.4.3 リアクション集計
- **ダッシュボード**:
  - 総リアクション数
  - リアクションタイプ別の内訳（横棒グラフ）
  - 目標値に対する進捗バー（1,000件）

---

### 3.5 ホストモード機能

#### 3.5.1 ホストモード有効化
- **方法**: URLクエリパラメータ
  - `?host=1`: ホストモードON
  - `&hostName={名前}`: ホスト表示名
- **例**: `/room/新人研修DAY1?host=1&hostName=講演者`

#### 3.5.2 ホストの特権
- **名前付き投稿**: 匿名IDではなく、指定した名前で投稿
- **バッジ表示**: 黄色の「ホスト」バッジ
- **メンション対象**: @メンションで識別可能
- **ホスト名変更**: リアルタイムで変更可能（LocalStorageに保存）

#### 3.5.3 ホストリンク共有
- **機能**: ホストモード用URLをワンクリックでコピー
- **処理**:
  - 現在のホスト名を含むURLを生成
  - クリップボードにコピー
  - 成功メッセージを表示（2秒間）

---

### 3.6 ダッシュボード機能

#### 3.6.1 メトリクス表示
- **メッセージ数**:
  - アイコン: 💬
  - カウント: リアルタイム更新
  - 目標値: 500件
  - 進捗バー: パーセンテージ表示
- **リアクション数**:
  - アイコン: ⚡
  - カウント: リアルタイム更新
  - 目標値: 1,000件
  - 進捗バー: パーセンテージ表示

#### 3.6.2 リアクション内訳
- **表示**: 横棒グラフ（100%積み上げ）
- **色分け**:
  - 👍 いいね: 黄色
  - 💡 ひらめき: 青色
  - 🤔 疑問: 緑色
  - 🍊 みかん: 紫色
- **パーセンテージ**: 各リアクションの割合を表示

#### 3.6.3 表示切替
- **コンパクトモード**: アイコン + カウントのみ
- **詳細モード**: 進捗バー + グラフ表示
- **デフォルト**: コンパクトモード（トグル可能）

---

### 3.7 共有機能

#### 3.7.1 参加リンク共有
- **機能**: 参加者用のURLをコピー
- **フォーマット**: `{origin}/#/room/{roomId}`
- **処理**: クリップボードにコピー
- **フィードバック**: 「コピーしました!」を2秒間表示

#### 3.7.2 ホストリンク共有
- **機能**: ホストモード用のURLをコピー
- **フォーマット**: `{origin}/#/room/{roomId}?host=1&hostName={hostName}`
- **処理**: クリップボードにコピー
- **フィードバック**: 「ホストリンクをコピーしました!」を2秒間表示

---

### 3.8 ナビゲーション機能

#### 3.8.1 ホーム復帰
- **条件**: SessionStorage に `allowHomeNavigation:{room}` が存在
- **表示**: ヘッダーに「← ホーム」リンク
- **処理**: ホーム画面へ遷移
- **権限**: ルーム作成者のみ（自動判定）

#### 3.8.2 ルーティング
- **トップページ**: `/` → ホーム画面
- **チャットルーム**: `/room/:roomId` → チャット画面
- **ルーター**: HashRouter（`#` ベース）

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

#### 4.1.1 レスポンスタイム
- **メッセージ送信**: 500ms以内にUI反映
- **リアクション**: 300ms以内にUI反映
- **初期ロード**: 3秒以内（モバイル4G回線）

#### 4.1.2 リアルタイム性
- **メッセージ配信遅延**: 1秒以内
- **リアクション同期**: 1秒以内
- **WebSocket再接続**: 自動（最大3回リトライ）

#### 4.1.3 スケーラビリティ
- **同時接続数**: ルームあたり最大100人
- **メッセージ数**: ルームあたり最大10,000件
- **リアクション数**: ルームあたり最大50,000件

---

### 4.2 ユーザビリティ要件

#### 4.2.1 モバイル対応
- **レスポンシブデザイン**: すべての画面でモバイル最適化
- **タッチ操作**: ボタンサイズ最小44x44px
- **ビューポート**:
  - `width=device-width, initial-scale=1.0`
  - `user-scalable=no`: ズーム無効化
  - `viewport-fit=cover`: ノッチ対応

#### 4.2.2 アクセシビリティ
- **キーボード操作**:
  - Enter: メッセージ送信
  - Shift+Enter: 改行
  - Escape: メンション候補を閉じる
- **フォーカス管理**: 送信後に入力欄にフォーカス
- **IME対応**: Composition Event処理

#### 4.2.3 多言語対応
- **言語**: 日本語のみ（将来的に英語対応予定）
- **文字コード**: UTF-8

---

### 4.3 互換性要件

#### 4.3.1 ブラウザ対応
- **デスクトップ**:
  - Chrome 最新版
  - Firefox 最新版
  - Safari 最新版
  - Edge 最新版
- **モバイル**:
  - iOS Safari 14+
  - Android Chrome 最新版

#### 4.3.2 デバイス対応
- **スマートフォン**: iPhone, Android
- **タブレット**: iPad, Android Tablet
- **デスクトップ**: Windows, macOS, Linux

---

### 4.4 可用性要件

#### 4.4.1 稼働率
- **目標**: 99.5%以上
- **計画停止**: メンテナンスウィンドウ（深夜帯）

#### 4.4.2 障害復旧
- **バックアップ**: Supabaseの自動バックアップ（毎日）
- **データ保持期間**: 無期限（手動削除まで）

#### 4.4.3 エラーハンドリング
- **ネットワークエラー**: ユーザーに通知、再接続を促す
- **Supabaseエラー**: システムメッセージで通知
- **デモモード**: Supabase未設定時は動作を継続

---

### 4.5 保守性要件

#### 4.5.1 コード品質
- **TypeScript**: Strict mode有効
- **型安全性**: すべてのコンポーネントで型定義
- **リンター**: （未設定、推奨: ESLint）
- **フォーマッター**: （未設定、推奨: Prettier）

#### 4.5.2 ドキュメント
- **README**: プロジェクト概要、セットアップ手順
- **コードコメント**: 複雑なロジックに注釈
- **型定義**: `types.ts` に集約

---

## 5. ユーザー体系

### 5.1 ユーザータイプ

#### 5.1.1 参加者（匿名ユーザー）
- **識別子**: `匿名の参加者#XXXX`（4桁の16進数）
- **権限**:
  - メッセージ送信
  - リアクション追加
  - @メンション
- **認証**: なし
- **登録**: 不要
- **永続性**: LocalStorageに保存（ブラウザキャッシュクリアで変更）

**ユーザーID生成ロジック**:
```typescript
const userId = `匿名の参加者#${Math.random().toString(16).substr(2, 4).toUpperCase()}`;
// 例: 「匿名の参加者#A1B2」
```

#### 5.1.2 ホスト（講演者・事務局）
- **識別子**: 任意の名前（例: 「講演者」「田中」）
- **権限**:
  - 名前付き投稿
  - メッセージ送信
  - リアクション追加
  - @メンション
  - ホストバッジ表示
- **認証**: なし（URLクエリパラメータで判定）
- **登録**: 不要
- **永続性**: LocalStorageに保存

**ホスト判定ロジック**:
```typescript
const isHostMode = new URLSearchParams(location.search).get('host') === '1';
const hostName = new URLSearchParams(location.search).get('hostName') || '';
```

#### 5.1.3 システム
- **識別子**: "システムメッセージ"
- **用途**:
  - デモモード通知
  - エラーメッセージ
  - システム通知
- **表示**: 中央寄せ、グレー色

---

### 5.2 ユーザー識別

#### 5.2.1 ユーザーID管理
- **保存先**: LocalStorage (`chat-user-id`)
- **生成タイミング**: 初回アクセス時
- **有効期限**: なし（永続）
- **変更**: ブラウザキャッシュクリア時に再生成

#### 5.2.2 ホスト名管理
- **保存先**: LocalStorage (`chat-host-name`)
- **初期値**: URLクエリパラメータ `hostName`
- **変更**: リアルタイムで入力可能
- **同期**: 変更後の投稿から反映

---

### 5.3 権限管理

#### 5.3.1 ルーム権限
- **参加**: すべてのユーザー
- **メッセージ送信**: すべてのユーザー
- **リアクション追加**: すべてのユーザー
- **ホーム復帰**: ルーム作成者のみ

#### 5.3.2 ホスト権限
- **名前付き投稿**: ホストのみ
- **バッジ表示**: ホストのみ
- **特別な権限なし**: メッセージ削除・編集などは不可

#### 5.3.3 データアクセス権限
- **読み取り**: すべてのユーザー（ルーム内のすべてのデータ）
- **書き込み**: すべてのユーザー（メッセージ・リアクション）
- **削除**: なし（削除機能未実装）

---

## 6. データモデル

### 6.1 データベース構造（Supabase PostgreSQL）

#### 6.1.1 messages テーブル
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY, DEFAULT uuid_generate_v4() | メッセージID |
| text | text | NOT NULL | メッセージ本文 |
| timestamp | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |
| user_id | text | NOT NULL | ユーザーID |
| room_id | text | NOT NULL | ルームID |
| is_host | boolean | DEFAULT false | ホスト判定 |
| host_name | text | NULL | ホスト表示名 |
| mentions | jsonb | NULL | @メンション対象ID配列 |

**インデックス**:
```sql
CREATE INDEX idx_messages_room_id ON messages(room_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
```

**データ例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "text": "@講演者 質問があります！",
  "timestamp": "2025-12-02T10:30:00Z",
  "user_id": "匿名の参加者#A1B2",
  "room_id": "新人研修DAY1",
  "is_host": false,
  "host_name": null,
  "mentions": ["講演者"]
}
```

#### 6.1.2 reactions テーブル
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY, DEFAULT uuid_generate_v4() | リアクションID |
| type | text | NOT NULL | リアクションタイプ |
| timestamp | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |
| room_id | text | NOT NULL | ルームID |

**インデックス**:
```sql
CREATE INDEX idx_reactions_room_id ON reactions(room_id);
```

**type の値**:
- `like`: 👍 いいね
- `idea`: 💡 ひらめき
- `question`: 🤔 疑問
- `confused`: 🍊 みかん

**データ例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "type": "like",
  "timestamp": "2025-12-02T10:31:00Z",
  "room_id": "新人研修DAY1"
}
```

#### 6.1.3 message_reactions テーブル
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY, DEFAULT uuid_generate_v4() | リアクションID |
| message_id | uuid | NOT NULL | 対象メッセージID |
| user_id | text | NOT NULL | リアクション者ID |
| room_id | text | NOT NULL | ルームID |
| timestamp | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |
| type | text | NOT NULL | リアクションタイプ |

**外部キー**:
```sql
FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
```

**インデックス**:
```sql
CREATE INDEX idx_message_reactions_message_id ON message_reactions(message_id);
CREATE INDEX idx_message_reactions_room_id ON message_reactions(room_id);
```

**データ例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "匿名の参加者#C3D4",
  "room_id": "新人研修DAY1",
  "timestamp": "2025-12-02T10:32:00Z",
  "type": "idea"
}
```

---

### 6.2 TypeScript型定義

```typescript
// types.ts より

interface Message {
  id: string;
  text: string;
  timestamp: string;
  user_id: string;
  isSender: boolean;         // クライアント側で追加（送信者判定）
  room_id: string;
  is_host?: boolean;
  host_name?: string;
  mentions?: string[];
}

interface Reaction {
  id: string;
  type: ReactionType;
  timestamp: string;
  room_id: string;
}

interface MessageReaction {
  id: string;
  message_id: string;
  user_id: string;
  room_id: string;
  timestamp: string;
  type: ReactionType;
}

type ReactionType = 'like' | 'idea' | 'question' | 'confused';

interface FlyingEmoji {
  id: number;
  emoji: string;
  x: number;                 // 表示位置X座標
  y: number;                 // 表示位置Y座標
}
```

---

### 6.3 データフロー

#### 6.3.1 メッセージ送信フロー
```
ユーザー入力
  ↓
Validation（空メッセージチェック）
  ↓
Supabase INSERT（messages テーブル）
  ↓
Postgres Changes イベント
  ↓
全クライアントに配信（WebSocket）
  ↓
UI更新（リアルタイム）
```

#### 6.3.2 リアクション追加フロー
```
ユーザークリック
  ↓
Supabase INSERT（reactions または message_reactions）
  ↓
アニメーション表示（飛ぶ絵文字）
  ↓
Postgres Changes イベント
  ↓
カウント更新（全クライアント）
```

#### 6.3.3 リアルタイム同期フロー
```
Supabase Realtime WebSocket
  ↓
useChatRoom.ts のコールバック
  ↓
React State更新（setMessages, setReactions）
  ↓
コンポーネント再レンダリング
  ↓
UI自動更新
```

---

## 7. 画面設計

### 7.1 画面一覧

| 画面ID | 画面名 | ルート | コンポーネント |
|--------|--------|--------|-------------|
| HOME-01 | ホーム画面 | `/` | HomePage.tsx |
| ROOM-01 | チャットルーム | `/room/:roomId` | RoomPage.tsx |

---

### 7.2 HOME-01: ホーム画面

#### 7.2.1 レイアウト
```
┌────────────────────────────────────┐
│         🏠 アイコン                 │
│   匿名リアルタイムチャット           │
│                                    │
│  ┌──────────────────────────┐     │
│  │ ルーム名を入力           │     │
│  └──────────────────────────┘     │
│                                    │
│  ┌──────────────────────────┐     │
│  │  ルームを作成/参加        │     │
│  └──────────────────────────┘     │
│                                    │
│  最近のルーム:                     │
│  • 新人研修DAY1                    │
│  • 技術勉強会                      │
│                                    │
└────────────────────────────────────┘
```

#### 7.2.2 UI要素
- **ロゴ**: 家アイコン（128x128px）
- **タイトル**: "匿名リアルタイムチャット"
- **入力フォーム**:
  - プレースホルダー: "ルーム名を入力"
  - 必須フィールド
- **ボタン**: "ルームを作成/参加"
  - 青色背景
  - ホバー時に濃い青色
- **最近のルーム**:
  - リスト表示（最大5件）
  - クリック可能
  - グレー色背景

#### 7.2.3 動作
1. ルーム名を入力
2. ボタンをクリック
3. `/room/{ルーム名}` へ遷移
4. ルーム名をLocalStorageに保存

---

### 7.3 ROOM-01: チャットルーム

#### 7.3.1 レイアウト（デスクトップ）
```
┌──────────────────────────────────────────────────────────┐
│ ← ホーム | 新人研修DAY1 | 💬 15 ⚡ 30 | 🔗 共有 | 🔗 ホスト │ ← ヘッダー
├──────────────────────────────────────────────────────────┤
│ [ダッシュボード] 💬 15件 ⚡ 30件                          │ ← ダッシュボード
├──────────────────────────────────────────────────────────┤
│ [ホストモード] ホスト名: [講演者___________]              │ ← ホストバー
├──────────────────────────────────────────────────────────┤
│                                                          │
│  匿名の参加者#A1B2  10:30                               │
│  ┌───────────────────────────┐                         │
│  │ こんにちは！                │                         │
│  └───────────────────────────┘                         │
│                                                          │
│                          講演者 [ホスト] 10:31         │
│                         ┌───────────────────────────┐   │
│                         │ ご参加ありがとうございます │   │
│                         └───────────────────────────┘   │
│                                                          │
│  匿名の参加者#C3D4  10:32                               │
│  ┌───────────────────────────┐                         │
│  │ @講演者 質問があります！    │                         │
│  └───────────────────────────┘                         │
│  👍 2  💡 1                                             │ ← メッセージリアクション
│                                                          │
│                                                          │ ← メッセージエリア
├──────────────────────────────────────────────────────────┤
│ [@講演者 ▼]                                              │ ← メンション候補
├──────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐  ✈️         │
│ │ 匿名でメッセージを送信...                │             │ ← フッター
│ └────────────────────────────────────────┘             │
│                                                          │
│ 👍  💡  🤔  🍊                                           │ ← リアクションボタン
└──────────────────────────────────────────────────────────┘
```

#### 7.3.2 レイアウト（モバイル）
```
┌────────────────────────────┐
│ ← | 新人研修DAY1           │ ← ヘッダー
│    💬 15 ⚡ 30            │
│    🔗 共有 | 🔗 ホスト      │
├────────────────────────────┤
│ 💬 15 ⚡ 30               │ ← ダッシュボード
├────────────────────────────┤
│ [ホスト] [講演者____]      │ ← ホストバー
├────────────────────────────┤
│                            │
│ 匿名#A1B2  10:30          │
│ ┌─────────────────┐       │
│ │ こんにちは！     │       │
│ └─────────────────┘       │
│                            │
│          講演者 10:31     │
│         ┌─────────────┐   │
│         │ ありがとう！ │   │
│         └─────────────┘   │
│                            │ ← メッセージエリア
├────────────────────────────┤
│ ┌──────────────────┐  ✈️ │
│ │ メッセージ...    │     │ ← 入力欄
│ └──────────────────┘     │
├────────────────────────────┤
│ 👍  💡  🤔  🍊            │ ← リアクション
└────────────────────────────┘
```

---

### 7.4 UIコンポーネント詳細

#### 7.4.1 ヘッダー（Header）
**要素**:
- **ホーム復帰リンク**:
  - 表示条件: `allowHomeNavigation` がtrue
  - テキスト: "← ホーム"
  - 色: 青色
- **ルーム名**:
  - フォントサイズ: 1.25rem
  - 太字
- **メトリクス**:
  - アイコン + カウント
  - 💬 メッセージ数
  - ⚡ リアクション数
- **共有ボタン**:
  - テキスト: "🔗 参加リンク"
  - 色: 青色
  - クリック: クリップボードコピー
- **ホストリンクボタン**:
  - テキスト: "🔗 ホストリンク"
  - 色: 緑色
  - クリック: クリップボードコピー

#### 7.4.2 ダッシュボード（Dashboard）
**コンパクトモード**:
- 💬 {メッセージ数}件
- ⚡ {リアクション数}件
- トグルボタン: "詳細を表示/非表示"

**詳細モード**:
- **メッセージ進捗**:
  - ラベル: "💬 メッセージ数"
  - カウント: {現在}/{目標}件
  - 進捗バー: 青色、パーセンテージ表示
- **リアクション進捗**:
  - ラベル: "⚡ リアクション数"
  - カウント: {現在}/{目標}件
  - 進捗バー: 緑色、パーセンテージ表示
- **リアクション内訳**:
  - 横棒グラフ（100%積み上げ）
  - 色分け: 黄色、青色、緑色、紫色
  - パーセンテージ表示

#### 7.4.3 ホストバー（Host Bar）
**表示条件**: `isHostMode` または `isDemoMode`

**要素**:
- **バッジ**:
  - テキスト: "ホストモード" または "デモモード"
  - 色: 黄色または青色
- **ホスト名入力**:
  - ラベル: "ホスト名:"
  - 入力フィールド: text input
  - プレースホルダー: "名前を入力"
  - 自動フォーカス: OFF

#### 7.4.4 メッセージアイテム（MessageItem）
**送信者（右寄せ）**:
- 背景色: 青色 (`bg-corp-blue-light`)
- テキスト色: 白色
- 配置: flex-row-reverse
- ユーザー名: 右寄せ

**受信者（左寄せ）**:
- 背景色: 白色（ライトモード）、グレー色（ダークモード）
- テキスト色: 黒色
- 配置: flex-row
- ユーザー名: 左寄せ

**共通要素**:
- **ユーザー名**:
  - フォントサイズ: 0.875rem
  - 太字
  - ホストバッジ: 黄色背景、"ホスト"
- **タイムスタンプ**:
  - フォーマット: HH:MM
  - フォントサイズ: 0.75rem
  - 色: グレー
- **メッセージ本文**:
  - 折り返し: word-break
  - リンク: 青色、下線
  - メンション: 青色背景、太字
- **リアクションピッカー**:
  - 表示条件: ホバー時（デスクトップ）、常時（モバイル）
  - ボタン: 4種類の絵文字
  - 配置: メッセージ下部
- **リアクションカウント**:
  - 表示: 絵文字 + カウント
  - 例: 👍 3, 💡 1
  - 配置: メッセージ下部

#### 7.4.5 メンション候補（Mention Suggestions）
**表示条件**: `@` 入力後、候補が存在

**要素**:
- **リスト**:
  - 最大10件
  - スクロール可能
  - 背景色: 白色
  - ボーダー: グレー色
- **アイテム**:
  - ユーザーID
  - ホストバッジ（該当する場合）
  - ホバー時: 青色背景
  - クリック: 挿入
- **配置**:
  - 入力欄の上部
  - 絶対位置配置

#### 7.4.6 フッター（Footer）
**要素**:
- **入力欄**:
  - タイプ: Textarea
  - プレースホルダー:
    - 匿名: "匿名でメッセージを送信..."
    - ホスト: "{hostName}として投稿..."
  - 行数: 自動拡張（最大5行）
  - ボーダー: グレー色
  - フォーカス時: 青色ボーダー
- **送信ボタン**:
  - アイコン: 紙飛行機 ✈️
  - 色: 青色
  - 無効条件: 空メッセージ
- **リアクションボタン**:
  - 4種類: 👍 💡 🤔 🍊
  - サイズ: 44x44px
  - レイアウト:
    - デスクトップ: 1行
    - モバイル: 2行（2x2）

#### 7.4.7 飛ぶ絵文字（Flying Emoji）
**アニメーション**:
- 開始位置: クリック位置
- 移動: 上方向に80px
- スケール: 1.0 → 0.5
- 透明度: 1.0 → 0.0
- 時間: 1秒
- イージング: ease-out

---

### 7.5 カラーパレット

#### 7.5.1 ブランドカラー
| 名称 | カラーコード | 用途 |
|------|------------|------|
| コーポレートブルー | #00529B | ヘッダー背景、リンク |
| ライトブルー | #007BFF | プライマリボタン、送信者メッセージ |
| グレー100 | #F7F9FA | 背景色（ライトモード） |
| グレー700 | #4A4A4A | テキスト色（ダーク） |
| グレー900 | #1A1A1A | 背景色（ダークモード） |

#### 7.5.2 リアクションカラー
| リアクション | 絵文字 | カラーコード | Tailwindクラス |
|------------|--------|------------|---------------|
| いいね | 👍 | #EAB308 | bg-yellow-500 |
| ひらめき | 💡 | #3B82F6 | bg-blue-500 |
| 疑問 | 🤔 | #10B981 | bg-green-500 |
| みかん | 🍊 | #A855F7 | bg-purple-500 |

#### 7.5.3 状態カラー
| 状態 | カラーコード | 用途 |
|------|------------|------|
| 成功 | #10B981 | 共有成功メッセージ |
| エラー | #EF4444 | エラーメッセージ |
| 警告 | #F59E0B | 警告メッセージ |
| 情報 | #3B82F6 | 情報メッセージ |

---

### 7.6 タイポグラフィ

#### 7.6.1 フォントファミリー
```css
font-family: system-ui, -apple-system, BlinkMacSystemFont,
  'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
```

#### 7.6.2 フォントサイズ
| 要素 | サイズ | Tailwindクラス |
|------|--------|---------------|
| タイトル（H1） | 2rem | text-4xl |
| サブタイトル（H2） | 1.5rem | text-2xl |
| ルーム名 | 1.25rem | text-xl |
| 本文 | 1rem | text-base |
| ユーザー名 | 0.875rem | text-sm |
| タイムスタンプ | 0.75rem | text-xs |

---

## 8. API設計

### 8.1 Supabaseクライアント

#### 8.1.1 初期化
```typescript
// supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

**環境変数**:
- `VITE_SUPABASE_URL`: SupabaseプロジェクトURL
- `VITE_SUPABASE_ANON_KEY`: 匿名認証キー

---

### 8.2 データ操作API

#### 8.2.1 メッセージ取得
```typescript
const { data, error } = await supabase
  .from('messages')
  .select('*')
  .eq('room_id', roomId)
  .order('timestamp', { ascending: true });
```

**パラメータ**:
- `room_id`: ルームID（必須）

**レスポンス**:
```typescript
Message[] // 時系列順にソート
```

#### 8.2.2 メッセージ送信
```typescript
const { error } = await supabase
  .from('messages')
  .insert([{
    text: message,
    room_id: roomId,
    user_id: userId,
    mentions: mentionedUsers,
    is_host: isHostMode,
    host_name: hostName
  }]);
```

**パラメータ**:
- `text`: メッセージ本文（必須）
- `room_id`: ルームID（必須）
- `user_id`: ユーザーID（必須）
- `mentions`: @メンション対象ID配列（オプション）
- `is_host`: ホスト判定（オプション、デフォルト: false）
- `host_name`: ホスト表示名（オプション）

**レスポンス**:
```typescript
{ error: null } // 成功時
{ error: Error } // エラー時
```

#### 8.2.3 リアクション追加（ルームレベル）
```typescript
const { error } = await supabase
  .from('reactions')
  .insert([{
    type: reactionType,
    room_id: roomId,
    timestamp: new Date().toISOString()
  }]);
```

**パラメータ**:
- `type`: リアクションタイプ（必須）
- `room_id`: ルームID（必須）
- `timestamp`: 作成日時（必須）

#### 8.2.4 メッセージリアクション追加
```typescript
const { error } = await supabase
  .from('message_reactions')
  .insert([{
    message_id: messageId,
    type: reactionType,
    user_id: userId,
    room_id: roomId,
    timestamp: new Date().toISOString()
  }]);
```

**パラメータ**:
- `message_id`: 対象メッセージID（必須）
- `type`: リアクションタイプ（必須）
- `user_id`: ユーザーID（必須）
- `room_id`: ルームID（必須）
- `timestamp`: 作成日時（必須）

#### 8.2.5 リアクション取得
```typescript
// ルームレベルのリアクション
const { data } = await supabase
  .from('reactions')
  .select('*')
  .eq('room_id', roomId);

// メッセージレベルのリアクション
const { data } = await supabase
  .from('message_reactions')
  .select('*')
  .eq('room_id', roomId);
```

---

### 8.3 リアルタイムAPI（WebSocket）

#### 8.3.1 メッセージチャネル
```typescript
const messagesChannel = supabase
  .channel(`messages-${roomId}`)
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
      filter: `room_id=eq.${roomId}`
    },
    (payload) => {
      const newMessage = {
        ...payload.new,
        isSender: payload.new.user_id === userId
      } as Message;
      setMessages(prev => [...prev, newMessage]);
    }
  )
  .subscribe();
```

**イベント**:
- `INSERT`: 新規メッセージ挿入時

**フィルター**:
- `room_id=eq.{roomId}`: 特定ルームのみ

#### 8.3.2 リアクションチャネル
```typescript
// ルームレベル
const reactionsChannel = supabase
  .channel(`reactions-${roomId}`)
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'reactions',
      filter: `room_id=eq.${roomId}`
    },
    (payload) => {
      setReactions(prev => [...prev, payload.new as Reaction]);
    }
  )
  .subscribe();

// メッセージレベル
const messageReactionsChannel = supabase
  .channel(`message-reactions-${roomId}`)
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'message_reactions',
      filter: `room_id=eq.${roomId}`
    },
    (payload) => {
      setMessageReactions(prev => [...prev, payload.new as MessageReaction]);
    }
  )
  .subscribe();
```

#### 8.3.3 チャネル解除
```typescript
return () => {
  messagesChannel.unsubscribe();
  reactionsChannel.unsubscribe();
  messageReactionsChannel.unsubscribe();
};
```

**タイミング**: コンポーネントアンマウント時

---

### 8.4 エラーハンドリング

#### 8.4.1 ネットワークエラー
```typescript
if (error) {
  console.error('メッセージの送信に失敗しました:', error);
  // ユーザーに通知（実装推奨）
}
```

#### 8.4.2 デモモード
```typescript
if (!supabaseUrl || !supabaseAnonKey) {
  // モッククライアントを返す
  return noopClient;
}
```

**動作**:
- Supabase未設定時はローカルStateのみで動作
- システムメッセージを表示

---

## 9. 技術仕様

### 9.1 フロントエンド

#### 9.1.1 フレームワーク
- **React**: 19.1.1
  - 関数コンポーネント
  - Hooks（useState, useEffect, useRef, useCallback）
  - Concurrent Features有効

#### 9.1.2 ルーティング
- **React Router DOM**: 7.9.1
  - HashRouter（`#` ベース）
  - 動的ルートパラメータ（`/room/:roomId`）

#### 9.1.3 UIライブラリ
- **Tailwind CSS**: CDN経由（3.4.x）
  - ユーティリティファースト
  - ダークモード対応
  - カスタムカラー拡張

#### 9.1.4 言語
- **TypeScript**: 5.8.2
  - Strict mode有効
  - JSX: react-jsx
  - モジュール解決: bundler

---

### 9.2 バックエンド

#### 9.2.1 データベース
- **Supabase PostgreSQL**
  - バージョン: 15.x
  - テーブル: `messages`, `reactions`, `message_reactions`
  - リアルタイム同期: 有効

#### 9.2.2 認証
- **匿名認証**: Supabase匿名キー
- **ユーザー管理**: LocalStorage

#### 9.2.3 リアルタイム通信
- **Supabase Realtime**
  - プロトコル: WebSocket
  - イベント: postgres_changes
  - チャネル: ルームごとに3つ（messages, reactions, message_reactions）

---

### 9.3 ビルド・デプロイ

#### 9.3.1 ビルドツール
- **Vite**: 6.2.0
  - 開発サーバー: `npm run dev`
  - ビルド: `npm run build`
  - プレビュー: `npm run preview`

#### 9.3.2 プラグイン
- **@vitejs/plugin-react**: 5.0.0
  - Fast Refresh
  - JSX Transform

#### 9.3.3 ビルド設定
```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  base: './', // 相対パス
});
```

#### 9.3.4 デプロイ
- **推奨**:
  - Vercel
  - Netlify
  - GitHub Pages（HashRouter対応）
- **要件**:
  - 静的ファイルホスティング
  - HTTPS対応
  - 環境変数設定

---

### 9.4 開発環境

#### 9.4.1 パッケージマネージャー
- **npm**: 推奨（package-lock.json管理）

#### 9.4.2 必須環境変数
```bash
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

#### 9.4.3 開発サーバー
```bash
npm run dev
# → http://localhost:5173
```

---

### 9.5 ファイル構成

```
/home/user/anonyChat/
├── components/           # Reactコンポーネント
│   ├── Dashboard.tsx     # ダッシュボード
│   ├── HomePage.tsx      # ホーム画面
│   ├── MessageItem.tsx   # メッセージアイテム
│   ├── RoomPage.tsx      # チャットルーム
│   └── icons.tsx         # SVGアイコン
├── hooks/                # カスタムフック
│   └── useChatRoom.ts    # チャットロジック
├── App.tsx               # ルートコンポーネント
├── index.tsx             # エントリーポイント
├── index.html            # HTMLテンプレート
├── types.ts              # TypeScript型定義
├── supabase.ts           # Supabase設定
├── metadata.json         # アプリメタデータ
├── package.json          # 依存関係
├── tsconfig.json         # TypeScript設定
├── vite.config.ts        # Viteビルド設定
└── .env                  # 環境変数
```

**総行数**: 1,297行
**プロジェクトサイズ**: 339KB

---

## 10. セキュリティ要件

### 10.1 認証・認可

#### 10.1.1 匿名認証
- **方式**: Supabase匿名キー
- **リスク**:
  - スパム投稿のリスク
  - ユーザー識別の限界
- **対策**:
  - Rate Limiting（実装推奨）
  - IP制限（実装推奨）

#### 10.1.2 ユーザーID管理
- **保存先**: LocalStorage
- **リスク**: ブラウザキャッシュクリアで変更可能
- **対策**: サーバー側でのIP追跡（実装推奨）

---

### 10.2 データ保護

#### 10.2.1 環境変数
- **機密情報**:
  - Supabase URL
  - 匿名キー
- **保護**:
  - `.env` ファイルに保存
  - `.gitignore` に追加
  - 本番環境はシークレット管理

#### 10.2.2 RLS（Row Level Security）
- **現状**: 未設定
- **推奨**:
  - ルームごとのアクセス制御
  - 削除権限の制限

---

### 10.3 XSS対策

#### 10.3.1 入力サニタイゼーション
- **方式**: React の自動エスケープ
- **リンク**: `rel="noopener noreferrer"`
- **追加対策**:
  - DOMPurify導入（実装推奨）
  - CSP（Content Security Policy）設定

---

### 10.4 CSRF対策

#### 10.4.1 現状
- **方式**: Supabase JWT認証
- **リスク**: 匿名認証のため限定的

---

### 10.5 通信セキュリティ

#### 10.5.1 HTTPS
- **要件**: すべての通信をHTTPSで実行
- **Supabase**: デフォルトでHTTPS

#### 10.5.2 WebSocket
- **プロトコル**: WSS（WebSocket Secure）
- **Supabase Realtime**: 自動でWSSを使用

---

## 11. 運用要件

### 11.1 監視

#### 11.1.1 推奨監視項目
- Supabase接続状態
- WebSocket接続数
- エラーレート
- レスポンスタイム

#### 11.1.2 ログ
- **クライアント側**: `console.error` でエラーログ
- **サーバー側**: Supabaseダッシュボード

---

### 11.2 バックアップ

#### 11.2.1 データベース
- **方式**: Supabase自動バックアップ
- **頻度**: 毎日
- **保持期間**: 7日間（プランによる）

---

### 11.3 スケーリング

#### 11.3.1 データベース
- **方式**: Supabaseの自動スケーリング
- **制限**: プランによる（無料プランは500MB）

#### 11.3.2 フロントエンド
- **方式**: CDNによる配信
- **推奨**: Vercel Edge Network

---

### 11.4 メンテナンス

#### 11.4.1 データクリーンアップ
- **推奨**: 古いルームの定期削除
- **方式**: Supabase Functions（実装推奨）
- **頻度**: 月次

#### 11.4.2 依存関係更新
- **頻度**: 四半期ごと
- **対象**:
  - React
  - Supabase JS
  - Vite

---

## 12. 制約事項

### 12.1 現在の制約

#### 12.1.1 機能制約
- **メッセージ編集**: 不可
- **メッセージ削除**: 不可
- **ファイル添付**: 不可
- **ユーザープロフィール**: なし
- **通知機能**: なし
- **検索機能**: なし

#### 12.1.2 データ制約
- **ルーム数**: 無制限（データベース容量まで）
- **メッセージ数**: ルームあたり無制限（パフォーマンス考慮推奨）
- **文字数制限**: なし（UI上は自然な制限）

#### 12.1.3 セキュリティ制約
- **認証**: 匿名のみ
- **アクセス制御**: なし
- **Rate Limiting**: 未実装

---

### 12.2 技術的制約

#### 12.2.1 ブラウザ制約
- **WebSocket**: 対応ブラウザのみ
- **LocalStorage**: プライベートブラウジングで制限

#### 12.2.2 Supabase制約
- **無料プラン**:
  - 500MB データベース
  - 2GB 帯域幅/月
  - 50MB ファイルアップロード
- **リアルタイム接続**: 同時接続数制限あり

---

## 13. 将来の拡張候補

### 13.1 機能拡張

#### 13.1.1 短期（1-3ヶ月）
- [ ] メッセージ検索機能
- [ ] ファイル添付（画像）
- [ ] メッセージ削除機能
- [ ] Rate Limiting実装
- [ ] エラーメッセージの多言語対応

#### 13.1.2 中期（3-6ヶ月）
- [ ] ユーザープロフィール機能
- [ ] プッシュ通知
- [ ] メッセージ編集機能
- [ ] ルーム管理画面（削除、設定）
- [ ] 管理者モード（モデレーション）

#### 13.1.3 長期（6ヶ月以上）
- [ ] ビデオ通話統合
- [ ] AIチャットボット
- [ ] アナリティクスダッシュボード
- [ ] エンタープライズ版（SSO、LDAP）
- [ ] ホワイトラベル対応

---

### 13.2 技術的改善

#### 13.2.1 パフォーマンス
- [ ] メッセージの仮想スクロール（react-window）
- [ ] 画像の遅延ロード
- [ ] サービスワーカー（PWA化）
- [ ] Code Splitting

#### 13.2.2 開発体験
- [ ] ESLint設定
- [ ] Prettier設定
- [ ] テスト（Jest, React Testing Library）
- [ ] CI/CD（GitHub Actions）
- [ ] Storybook

#### 13.2.3 セキュリティ
- [ ] RLS（Row Level Security）設定
- [ ] CSP（Content Security Policy）
- [ ] DOMPurify統合
- [ ] 監視・アラート（Sentry）

---

## 14. 付録

### 14.1 用語集

| 用語 | 説明 |
|------|------|
| ルーム | チャットが行われる仮想空間 |
| 匿名ユーザー | 認証なしで参加するユーザー |
| ホスト | 講演者・事務局など、名前付きで投稿できるユーザー |
| リアクション | 絵文字による反応（ルームレベル） |
| メッセージリアクション | 特定メッセージへの絵文字反応 |
| @メンション | 特定ユーザーへの言及 |
| デモモード | Supabase未設定時のローカル動作モード |

---

### 14.2 参考資料

#### 14.2.1 公式ドキュメント
- **React**: https://react.dev/
- **React Router**: https://reactrouter.com/
- **Supabase**: https://supabase.com/docs
- **Vite**: https://vitejs.dev/
- **Tailwind CSS**: https://tailwindcss.com/

#### 14.2.2 コードリポジトリ
- **GitHub**: `taizennishiyama-tiermind/anonyChat`
- **ブランチ**: `claude/reverse-engineer-requirements-01HghEFsTW7GKKj8cARewvK3`

---

### 14.3 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|---------|------|---------|--------|
| 1.0 | 2025-12-02 | 初版作成（リバースエンジニアリング） | Claude Code |

---

## 15. まとめ

**匿名リアルタイムチャット（anonyChat）** は、企業研修向けの軽量かつ高速なリアルタイムメッセージングシステムです。以下の特徴を持ちます：

### 15.1 核心的価値
1. **低い参加障壁**: URL共有のみで即座に利用可能
2. **心理的安全性**: 匿名性による発言のしやすさ
3. **リアルタイムフィードバック**: 講演者が参加者の反応を即座に把握
4. **モバイルファースト**: スマートフォンからの快適な利用

### 15.2 技術的優位性
1. **最小限の依存関係**: React + Supabaseのシンプルな構成
2. **スケーラブル**: Supabaseによる自動スケーリング
3. **高速開発**: Viteによる高速ビルド
4. **型安全**: TypeScriptによる堅牢性

### 15.3 推奨利用シーン
- 企業の新人研修（50-100人規模）
- 社内講演会・勉強会
- ウェビナー・オンラインセミナー
- ワークショップでのアイデア収集

---

**この要件定義書は、現在のコードベース（2025-12-02時点）を完全に分析した結果に基づいています。**

---

*End of Document*
